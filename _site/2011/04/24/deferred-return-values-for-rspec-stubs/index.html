<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <meta name="google-site-verification" content="uPo9ejFsAXhqlhxbsrVtWkBWHQQDUGvP5lSSqj5Mb54" />

  <title>Blocky RSpec Stubbing</title>

  <link rel="stylesheet" type="text/css" href="/public/css/main.css" media="all">
  <link rel="stylesheet" type="text/css" href="/public/css/highlight.css" media="all">

  <script type="text/javascript" src="http://use.typekit.com/npn1una.js"></script>
  <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>

<body>
  <section id="sidebar">
    <a href="/">
      <img src="/public/images/metal.png" alt="mattenoble" />
    </a>

    <section id="meta">
      <a href="https://github.com/mnoble" class="github">github</a>
      <a href="https://twitter.com/mattenoble" class="twitter">twitter</a>
      <a href="/atom.xm" class="rss">rss</a>
    </section>
  </section>

  <section id="content">
    <div class="article">
    <h1>Blocky RSpec Stubbing</h1>
    <p>While working on <a href="http://github.com/mnoble/tabby">Tabby</a> I hit an issue when stubbing Tempfile.new. Instead of creating a Tempfile I wanted to just use a StringIO-ish (<code>FakeFile</code>) object so I didn&#8217;t write to the filesystem.</p>
<h3>The Problem</h3>
<p>Liquid error: Output for xhtml in clouds style is not yet implemented</p>
<p>The problem is that Tabby creates a new Tempfile for every tab it needs to make, meaning it can be multiple times depending on the setup.</p>
<p>So one of the setups in my tests has two tabs. For the first tab, my FakeFile object was opened, written to and closed. The next tab did the same, to that same exact FakeFile instance. Since it was already closed, I got <code>IOError: not opened for writing</code>. Lame.</p>
<h3>The Solution</h3>
<p>RSpec&#8217;s <code>and_returns</code> takes a block, that is evaluated when the stubbed method is called. This way it&#8217;s invoked from a different context each time, giving us a brand new FakeFile each time.</p>
<p>Liquid error: Output for xhtml in clouds style is not yet implemented</p>
<p>So if you have a stub that needs to return the same type of object, but a brand spank&#8217;n new instance of it each time, use a block.</p>
</div>

<ul id="article-nav">

    <li id="previous"><a href="/2011/04/02/value-of-it-just-working/">&laquo; Previous</a></li>


    <li id="next"><a href="/2011/05/11/the-value-of-i-dont-know/">Next &raquo;</a></li>

</ul>

    <ul id="archive">
      
      <li>
        <a href="/2011/08/20/csstree-an-ultra-simple-css-parser/" class="title">CSSTree - An ultra-simple CSS parser</a>
        <span>August 20, 2011</span>
      </li>
      
      <li>
        <a href="/2011/05/30/ruby-enumerables/" class="title">Ruby Enumerables</a>
        <span>May 30, 2011</span>
      </li>
      
      <li>
        <a href="/2011/05/12/tabby/" class="title">Tabby - iTerm2 Environments</a>
        <span>May 12, 2011</span>
      </li>
      
      <li>
        <a href="/2011/05/11/the-value-of-i-dont-know/" class="title">The Value of I Don't Know</a>
        <span>May 11, 2011</span>
      </li>
      
      <li>
        <a href="/2011/04/24/deferred-return-values-for-rspec-stubs/" class="title">Blocky RSpec Stubbing</a>
        <span>April 24, 2011</span>
      </li>
      
      <li>
        <a href="/2011/04/02/value-of-it-just-working/" class="title">Taking Care of Business</a>
        <span>April 02, 2011</span>
      </li>
      
      <li>
        <a href="/2011/03/30/TADDD/" class="title">Test and Design Driven Development</a>
        <span>March 30, 2011</span>
      </li>
      
      <li>
        <a href="/2011/03/22/forge-python-fixture-replacement/" class="title">Forge - Python Fixture Replacement</a>
        <span>March 22, 2011</span>
      </li>
      
      <li>
        <a href="/2011/02/08/a-developers-introduction-to-puppet/" class="title">A Developer's Introduction to Puppet</a>
        <span>February 08, 2011</span>
      </li>
      
      <li>
        <a href="/2011/01/18/new-year-new-site/" class="title">New Year, New Site</a>
        <span>January 18, 2011</span>
      </li>
      
    </ul>
  </section>
</body>
</html>
