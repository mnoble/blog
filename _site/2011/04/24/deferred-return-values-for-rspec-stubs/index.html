<!DOCTYPE HTML>
<html lang="en-US">
<head>
    <meta charset="UTF-8">
    <meta name="google-site-verification" content="uPo9ejFsAXhqlhxbsrVtWkBWHQQDUGvP5lSSqj5Mb54" />
    
    <title>Blocky RSpec Stubbing</title>
    
    <link rel="stylesheet" type="text/css" href="/public/css/main.css" media="all">
    <link rel="stylesheet" type="text/css" href="/public/css/clouds.css" media="all">
    <script type="text/javascript" src="http://use.typekit.com/npn1una.js"></script>
    <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
</head>
<body>
    <div id="wrap">
        <h1>
            <a href="/">
                <p>MATTENOBLE</p>
                <img src="/public/images/gem.png" alt="rubygem" />
                <div style="clear:both;"></div>
            </a>
        </h1>
        
        <div id="content">
            <div id="articles">
                <div class="article">
    <h1>Blocky RSpec Stubbing</h1>
    <p>While working on <a href="http://github.com/mnoble/tabby">Tabby</a> I hit an issue when stubbing Tempfile.new. Instead of creating a Tempfile I wanted to just use a StringIO-ish (<code>FakeFile</code>) object so I didn&#8217;t write to the filesystem.</p>
<h3>The Problem</h3>
<pre class="clouds">
<span class="LibraryClassType">Tempfile</span>.<span class="FunctionName">stub</span>(<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>new</span>).<span class="FunctionName">and_return</span>(<span class="LibraryClassType">FakeFile</span>.<span class="FunctionName">new</span>)
</pre><p>The problem is that Tabby creates a new Tempfile for every tab it needs to make, meaning it can be multiple times depending on the setup.</p>
<p>So one of the setups in my tests has two tabs. For the first tab, my FakeFile object was opened, written to and closed. The next tab did the same, to that same exact FakeFile instance. Since it was already closed, I got <code>IOError: not opened for writing</code>. Lame.</p>
<h3>The Solution</h3>
<p>RSpec&#8217;s <code>and_returns</code> takes a block, that is evaluated when the stubbed method is called. This way it&#8217;s invoked from a different context each time, giving us a brand new FakeFile each time.</p>
<pre class="clouds">
<span class="LibraryClassType">Tempfile</span>.<span class="FunctionName">stub</span>(<span class="UserDefinedConstant"><span class="UserDefinedConstant">:</span>new</span>).<span class="FunctionName">and_return</span> { <span class="LibraryClassType">FakeFile</span>.<span class="FunctionName">new</span> }
</pre><p>So if you have a stub that needs to return the same type of object, but a brand spank&#8217;n new instance of it each time, use a block.</p>
</div>

<ul id="article-nav">

    <li id="previous"><a href="/2011/04/02/value-of-it-just-working/">&laquo; Previous</a></li>


</ul>
            </div>
            
        
            <ul id="article-nav">
            
            
            
            </ul>
        
        </div>
        
        <div id="sidebar">
            <p id="bio">
                I'm Matte Noble, a Software Developer, Ruby
                enthusiast, Metalhead and all around curious guy.
                This is where I share things I know and learn.
            </p>
            
            <ul>
                <li id="archive"><a href="/archive/">Archive</a></li>
                <li id="rss"><a href="/atom.xml">RSS</a></li>
                <li id="twitter"><a href="http://twitter.com/mattenoble">@mattenoble</a></li>
                <li id="github"><a href="http://github.com/mnoble">github.com/mnoble</a></li>
            </ul>
        </div>
        
        <div style="clear:both;"></div>
    </div>
</body>
</html>